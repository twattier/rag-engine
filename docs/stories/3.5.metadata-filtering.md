# Story 3.5: Implement Metadata-Based Pre-Filtering for Retrieval

**Epic:** Epic 3 - Graph-Based Retrieval, Knowledge Graph Construction & Visualization
**Story ID:** 3.5
**Status:** Draft
**Estimated Effort:** 4 story points (1 day)

---

## User Story

**As a** knowledge base user,
**I want** to filter retrieval by metadata fields before searching,
**so that** queries are faster and more precise by searching only relevant documents.

---

## Acceptance Criteria

1. Query endpoint accepts `metadata_filters` parameter with JSON object: `{"department": "engineering", "date": {"gte": "2024-01-01"}}`
2. Filter operators supported: equality, inequality, date ranges (`gte`, `lte`), tag inclusion (`in`), boolean logic (`AND`, `OR`)
3. Pre-filtering applies Neo4j Cypher query constraints before retrieval, narrowing search space
4. Filtered retrieval returns only results from documents matching metadata criteria
5. Query response includes `filtered_document_count` showing how many documents matched metadata filters
6. Performance improvement: metadata filtering on 20% of knowledge base demonstrates 40%+ latency reduction vs. unfiltered
7. Neo4j indexes created on common metadata fields (department, date_created, project_name) for performance
8. Integration test verifies metadata filtering with complex queries (AND/OR logic, date ranges)

---

## Tasks / Subtasks

- [ ] **Task 1: Extend query endpoint with metadata filters** (AC: 1, 2)
  - [ ] Add `metadata_filters: Optional[Dict]` to QueryRequest model
  - [ ] Implement filter parsing: equality, inequality, date ranges, tags, AND/OR logic
  - [ ] Build Cypher WHERE clauses from filter specifications

- [ ] **Task 2: Implement pre-filtering in query service** (AC: 3, 4)
  - [ ] Add metadata filtering to all retrieval modes (naive, local, global, hybrid)
  - [ ] Query filtered documents first: `MATCH (d:Document) WHERE d.metadata.department = 'engineering'`
  - [ ] Pass filtered document IDs to LightRAG query

- [ ] **Task 3: Add filtered document count to response** (AC: 5)
  - [ ] Count documents matching metadata filters before retrieval
  - [ ] Add `filtered_document_count` field to QueryResponse

- [ ] **Task 4: Create Neo4j metadata indexes** (AC: 7)
  - [ ] Create index on department: `CREATE INDEX metadata_department_idx ...`
  - [ ] Create index on date_created
  - [ ] Create index on project_name

- [ ] **Task 5: Performance testing** (AC: 6)
  - [ ] Test query latency with and without metadata filtering
  - [ ] Verify 40%+ latency reduction on 20% subset

- [ ] **Task 6: Integration tests** (AC: 8)
  - [ ] Test: Filter by department, verify only matching docs returned
  - [ ] Test: Date range filtering (gte, lte)
  - [ ] Test: Complex filters (AND/OR logic)

---

## Dev Notes

### Filter Syntax Examples

```json
{
  "department": "engineering",
  "date_created": {"gte": "2024-01-01", "lte": "2024-12-31"},
  "tags": {"in": ["python", "ml"]},
  "is_public": true
}
```

### Performance Target (NFR9)
- 40%+ latency reduction when filtering to 20% of knowledge base

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-17 | 1.0 | Story created from Epic 3 | Sarah (PO Agent) |

---

## Dev Agent Record
<!-- Populated during implementation -->

## QA Results
<!-- Results from QA Agent review -->

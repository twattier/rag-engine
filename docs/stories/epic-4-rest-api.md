# Epic 4: REST API & Integration Layer

**Status:** Draft
**Epic Goal:** Develop unified FastAPI REST API with OpenAPI documentation, covering document ingestion, query/retrieval, knowledge base management, and metadata filtering endpoints. API provides developer-friendly integration surface abstracting LightRAG and RAG-Anything complexity.

---

## Stories in this Epic

## Story 4.1: Consolidate API Endpoints and Create Unified API Gateway

**As a** API consumer,
**I want** a single API gateway with consistent endpoint patterns,
**so that** I have a unified interface for all RAG Engine operations.

### Acceptance Criteria

1. API service orchestrates calls to `lightrag-integration` and `rag-anything-integration` services
2. All API endpoints follow RESTful conventions: `/api/v1/{resource}` pattern
3. Endpoints organized by routers: `documents.py`, `query.py`, `graph.py`, `config.py`
4. Consistent error response format: `{"error": "error_code", "message": "human-readable message", "details": {...}}`
5. HTTP status codes used correctly: 200 (success), 201 (created), 400 (bad request), 401 (unauthorized), 404 (not found), 422 (validation error), 500 (internal error)
6. All endpoints require API key authentication via `Authorization: Bearer <api_key>` header
7. API versioning via URL path (`/api/v1/`) for future compatibility
8. OpenAPI spec updated with all endpoints, request/response schemas, authentication requirements

## Story 4.2: Implement API Authentication and Rate Limiting

**As a** platform operator,
**I want** API key-based authentication and rate limiting,
**so that** I can control access and prevent abuse.

### Acceptance Criteria

1. API keys generated via admin script: `scripts/generate-api-key.sh` (stores in `.env` or database)
2. Authentication middleware validates API key on all endpoints (except `/health` and `/docs`)
3. Invalid or missing API key returns 401 with `{"error": "unauthorized", "message": "Invalid or missing API key"}`
4. Rate limiting implemented: default 100 requests/minute per API key (configurable via `.env`: `RATE_LIMIT_PER_MINUTE`)
5. Rate limit exceeded returns 429 with `{"error": "rate_limit_exceeded", "message": "Rate limit of 100 requests/minute exceeded", "retry_after": 30}`
6. Rate limit headers included in responses: `X-RateLimit-Limit`, `X-RateLimit-Remaining`, `X-RateLimit-Reset`
7. Documentation in `docs/authentication.md` explains API key generation, usage, and rate limiting
8. Integration test verifies authentication enforcement and rate limiting behavior

## Story 4.3: Create Comprehensive OpenAPI Specification and Interactive Docs

**As a** developer integrating RAG Engine,
**I want** complete API documentation with examples and interactive testing,
**so that** I can understand and test endpoints without reading code.

### Acceptance Criteria

1. OpenAPI 3.0 specification generated by FastAPI includes:
   - All endpoints with descriptions
   - Request/response schemas with examples
   - Authentication requirements
   - Error response schemas
2. Example requests/responses for each endpoint showing realistic data
3. Swagger UI (`/docs`) allows testing endpoints with API key authentication
4. ReDoc UI (`/redoc`) provides alternative documentation view
5. OpenAPI JSON downloadable at `/openapi.json` for code generation tools
6. Custom OpenAPI metadata: title ("RAG Engine API"), description, version, contact information
7. Documentation includes common workflow examples: "Ingest and query a document", "Batch upload with metadata"
8. API changelog maintained in `docs/api-changelog.md` for version tracking

## Story 4.4: Implement Request Validation and Error Handling

**As a** API consumer,
**I want** clear validation errors and helpful error messages,
**so that** I can quickly fix invalid requests.

### Acceptance Criteria

1. Pydantic models used for all request/response validation with field descriptions and examples
2. Validation errors return 422 with detailed field-level errors:
   ```json
   {"error": "validation_error", "message": "Request validation failed", "details": [{"field": "metadata.date", "error": "Invalid date format, expected YYYY-MM-DD"}]}
   ```
3. Business logic errors return appropriate status codes with clear messages (e.g., 404 for document not found, 409 for duplicate entity)
4. Internal errors (500) logged with stack traces but return generic error message to client for security
5. Custom exception handlers for common error scenarios: Neo4j connection failures, LLM timeout, parsing errors
6. Error responses include `request_id` for tracing in logs
7. Documentation in `docs/error-handling.md` lists common errors with resolution steps
8. Integration tests verify error handling for invalid requests, missing documents, service failures

## Story 4.5: Create API Client Examples and Integration Guides

**As a** developer,
**I want** code examples in multiple languages,
**so that** I can quickly integrate RAG Engine into my application.

### Acceptance Criteria

1. `docs/api-examples/` contains working code examples in:
   - Python (using `requests` library)
   - JavaScript/Node.js (using `fetch` or `axios`)
   - cURL commands for command-line testing
2. Examples cover common scenarios:
   - Authenticate and ingest a document
   - Query knowledge base with metadata filtering
   - Batch upload documents with CSV metadata
   - Retrieve and delete documents
3. Each example includes: setup instructions, complete working code, expected output
4. Python example can be run as standalone script: `python docs/api-examples/python-ingest-query.py`
5. Examples use realistic sample documents and metadata
6. Documentation in `docs/integration-guide.md` provides architecture overview for integration planning
7. Examples hosted in repository and tested in CI/CD to ensure they remain functional

---

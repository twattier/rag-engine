# Story 3.6: Integrate Reranking Pipeline for Result Refinement

**Epic:** Epic 3 - Graph-Based Retrieval, Knowledge Graph Construction & Visualization
**Story ID:** 3.6
**Status:** Draft
**Estimated Effort:** 4 story points (1 day)

---

## User Story

**As a** knowledge seeker,
**I want** retrieval results reranked by relevance to my query,
**so that** the most useful results appear first.

---

## Acceptance Criteria

1. Reranking service integrated using open-source cross-encoder: Jina AI reranker (`jina-reranker-v2-base-multilingual`) or MS Marco (`ms-marco-MiniLM-L-12-v2`)
2. Query endpoint accepts `rerank` parameter (boolean, default: false for MVP)
3. Reranking applied to top-k retrieval results (configurable, default: rerank top 50, return top 10)
4. Reranked results include: original_score (from retrieval), rerank_score, final_rank
5. Reranking model runs locally (no external API calls) for privacy
6. Reranking adds <500ms latency to query pipeline (measured on 50 candidates)
7. Configuration in `.env`: `RERANKER_MODEL`, `RERANKER_ENABLED` (default: false for performance)
8. Integration test validates reranking changes result order, top result after reranking has higher relevance than before

---

## Tasks / Subtasks

- [ ] **Task 1: Set up reranking model** (AC: 1, 5, 7)
  - [ ] Add reranker dependency: `sentence-transformers` (includes cross-encoders)
  - [ ] Download Jina reranker or MS Marco model at startup
  - [ ] Add env vars: `RERANKER_MODEL`, `RERANKER_ENABLED` (default: false)
  - [ ] Cache model in memory

- [ ] **Task 2: Implement reranking service** (AC: 2, 3, 4)
  - [ ] Create `services/lightrag-integration/app/services/reranker.py`
  - [ ] Implement `rerank(query, candidates, top_k)` function
  - [ ] Return results with original_score, rerank_score, final_rank

- [ ] **Task 3: Integrate reranking into query pipeline** (AC: 2, 6)
  - [ ] Add `rerank: bool` parameter to QueryRequest
  - [ ] If rerank=true: retrieve top_k*5 results, rerank, return top_k
  - [ ] Measure and log reranking latency (target: <500ms for 50 candidates)

- [ ] **Task 4: Integration tests** (AC: 8)
  - [ ] Test: Query with rerank=false vs rerank=true
  - [ ] Verify result order changes after reranking
  - [ ] Measure reranking latency (<500ms)

---

## Dev Notes

### Reranking Process

```
Retrieval Results (top 50)
  → Pass to cross-encoder with query
  → Cross-encoder scores each (query, passage) pair
  → Sort by rerank score
  → Return top 10
```

### Model Options
- **Jina AI reranker**: Multilingual, good quality
- **MS Marco MiniLM**: Lightweight, fast

### Performance Target
- Reranking latency: <500ms for 50 candidates

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-17 | 1.0 | Story created from Epic 3 | Sarah (PO Agent) |

---

## Dev Agent Record
<!-- Populated during implementation -->

## QA Results
<!-- Results from QA Agent review -->

# Story 2.5: Create Entity Type Configuration and Pre-Ingestion Setup

**Epic:** Epic 2 - Multi-Format Document Ingestion Pipeline
**Story ID:** 2.5
**Status:** Draft
**Estimated Effort:** 3 story points (4-5 hours)

---

## User Story

**As a** domain specialist,
**I want** to specify expected entity types for my knowledge domain,
**so that** LightRAG extracts relevant entities during graph construction.

---

## Acceptance Criteria

1. Configuration file `config/entity-types.yaml` allows defining custom entity types with: type_name, description, examples
2. Default entity types provided: person, organization, concept, product, location, technology, event, document
3. Entity types configuration loaded at service startup and accessible via API
4. API endpoint `GET /api/v1/config/entity-types` returns currently configured entity types
5. API endpoint `POST /api/v1/config/entity-types` allows adding new entity types (persisted to config file)
6. Entity types passed to LightRAG during graph construction (Epic 3 integration point)
7. `.env.example` includes `ENTITY_TYPES_CONFIG_PATH` variable
8. Documentation in `docs/entity-configuration.md` with domain-specific examples (legal, medical, technical documentation)

---

## Tasks / Subtasks

- [ ] **Task 1: Create entity types Pydantic models** (AC: 1, 2)
  - [ ] Create `shared/models/entity_types.py` module
  - [ ] Define `EntityTypeDefinition` Pydantic model with type_name, description, examples
  - [ ] Define `EntityTypesConfig` Pydantic model containing list of entity types
  - [ ] Add validation for unique type names
  - [ ] Add type hints and docstrings

- [ ] **Task 2: Create YAML entity types configuration file** (AC: 1, 2)
  - [ ] Create `config/entity-types.yaml` with default entity types
  - [ ] Define 8 default types: person, organization, concept, product, location, technology, event, document
  - [ ] Include descriptions for each entity type
  - [ ] Include 3-5 examples per entity type
  - [ ] Add comments explaining configuration structure

- [ ] **Task 3: Implement configuration loader** (AC: 3)
  - [ ] Create `shared/config/entity_loader.py` module
  - [ ] Implement `load_entity_types(file_path)` function
  - [ ] Handle YAML parsing errors gracefully
  - [ ] Validate entity types configuration
  - [ ] Add caching for loaded configuration

- [ ] **Task 4: Create GET entity types endpoint** (AC: 4)
  - [ ] Create `services/api/routers/config.py` module
  - [ ] Add `GET /api/v1/config/entity-types` endpoint
  - [ ] Return list of configured entity types
  - [ ] Include type_name, description, examples in response
  - [ ] Add OpenAPI documentation

- [ ] **Task 5: Create POST entity types endpoint** (AC: 5)
  - [ ] Add `POST /api/v1/config/entity-types` to config router
  - [ ] Accept new entity type definition
  - [ ] Validate type_name uniqueness
  - [ ] Append to existing configuration
  - [ ] Persist to `config/entity-types.yaml` file
  - [ ] Reload configuration cache
  - [ ] Return updated entity types list

- [ ] **Task 6: Add environment configuration** (AC: 7)
  - [ ] Add `ENTITY_TYPES_CONFIG_PATH` to `.env.example`
  - [ ] Set default value to `config/entity-types.yaml`
  - [ ] Update `services/api/config.py` to include entity types path
  - [ ] Document environment variable in `.env.example` comments

- [ ] **Task 7: Create LightRAG integration interface** (AC: 6)
  - [ ] Create `shared/models/lightrag_config.py` (placeholder)
  - [ ] Define interface for passing entity types to LightRAG
  - [ ] Document integration point for Epic 3
  - [ ] Add TODO comments for Epic 3 implementation

- [ ] **Task 8: Create unit tests** (AC: 1, 2, 3, 4, 5)
  - [ ] Create `shared/tests/test_entity_types.py`
  - [ ] Test EntityTypeDefinition validation
  - [ ] Test EntityTypesConfig loading from YAML
  - [ ] Test GET endpoint returns default entity types
  - [ ] Test POST endpoint adds new entity type
  - [ ] Test POST endpoint validates uniqueness
  - [ ] Test configuration persistence to YAML file

- [ ] **Task 9: Create documentation** (AC: 8)
  - [ ] Create `docs/entity-configuration.md`
  - [ ] Document YAML configuration structure
  - [ ] Provide domain-specific examples (legal, medical, technical)
  - [ ] Document API endpoints for entity type management
  - [ ] Include best practices for entity type definition
  - [ ] Document LightRAG integration (Epic 3 preview)

---

## Dev Notes

### Tech Stack
[Source: architecture/tech-stack.md]

- **Python**: 3.11+ (type hints, Pydantic V2 support)
- **Backend Framework**: FastAPI 0.115+ (API endpoints)
- **Validation**: Pydantic 2.x (entity type models)
- **YAML Parser**: PyYAML (configuration file parsing)
- **Testing Framework**: pytest (unit tests)

### Project Structure
[Source: architecture/unified-project-structure.md]

File locations for implementation:

```
shared/
├── models/
│   ├── __init__.py
│   ├── entity_types.py          # Pydantic entity type models
│   └── lightrag_config.py       # LightRAG integration interface
├── config/
│   ├── __init__.py
│   └── entity_loader.py         # Configuration loader
└── tests/
    ├── __init__.py
    └── test_entity_types.py     # Unit tests

config/
└── entity-types.yaml            # YAML configuration file

services/api/
├── routers/
│   ├── __init__.py
│   └── config.py                # Entity types API endpoints
├── dependencies.py              # FastAPI dependencies (entity types loader)
├── config.py                    # Settings with ENTITY_TYPES_CONFIG_PATH
└── tests/
    └── integration/
        └── test_entity_config.py    # API integration tests

docs/
└── entity-configuration.md      # User documentation
```

### Component Architecture
[Source: architecture/components.md]

**Entity Types Configuration Responsibility:**
Define expected entity types for domain-specific knowledge graph construction. Enables LightRAG to extract relevant entities based on knowledge domain.

**Key Interfaces to Implement:**
- `load_entity_types(file_path: str) -> EntityTypesConfig` - Load entity types from YAML
- `add_entity_type(entity_type: EntityTypeDefinition)` - Add new entity type dynamically
- `get_entity_types() -> EntityTypesConfig` - FastAPI dependency for entity types access
- `save_entity_types(config: EntityTypesConfig, file_path: str)` - Persist to YAML

**Dependencies:**
- PyYAML for configuration parsing
- Pydantic V2 for model validation
- FastAPI for API endpoints
- LightRAG Service (Epic 3 - integration point)

### Entity Types YAML Structure
[Source: Epic 2 Story 2.5 AC1, AC2]

Example configuration:

```yaml
# config/entity-types.yaml
entity_types:
  - type_name: person
    description: "Individual people, including names, roles, and titles"
    examples:
      - "John Doe"
      - "Dr. Jane Smith"
      - "CEO Bob Johnson"
      - "Professor Alice Williams"

  - type_name: organization
    description: "Companies, institutions, agencies, and groups"
    examples:
      - "Microsoft Corporation"
      - "Stanford University"
      - "World Health Organization"
      - "Acme Inc."

  - type_name: concept
    description: "Abstract ideas, theories, methodologies, and principles"
    examples:
      - "Machine Learning"
      - "Agile Methodology"
      - "Supply Chain Management"
      - "Quantum Computing"

  - type_name: product
    description: "Products, services, tools, and offerings"
    examples:
      - "iPhone 15"
      - "Microsoft Azure"
      - "Adobe Photoshop"
      - "Tesla Model 3"

  - type_name: location
    description: "Geographic locations, places, addresses, and regions"
    examples:
      - "San Francisco, CA"
      - "Building A, Floor 3"
      - "United States"
      - "Silicon Valley"

  - type_name: technology
    description: "Technologies, frameworks, programming languages, and technical tools"
    examples:
      - "Python"
      - "React.js"
      - "Docker"
      - "Neo4j"

  - type_name: event
    description: "Events, meetings, conferences, and significant occurrences"
    examples:
      - "Project Kickoff Meeting"
      - "AWS re:Invent 2025"
      - "Q4 Budget Review"
      - "Product Launch"

  - type_name: document
    description: "Documents, reports, policies, and written materials"
    examples:
      - "Employee Handbook"
      - "API Documentation"
      - "Privacy Policy"
      - "Q3 Financial Report"
```

### Domain-Specific Entity Types Examples
[Source: Epic 2 Story 2.5 AC8]

**Legal Domain:**
```yaml
entity_types:
  - type_name: statute
    description: "Laws, statutes, codes, and legal regulations"
    examples: ["42 U.S.C. § 1983", "California Civil Code § 1798.100"]

  - type_name: case
    description: "Legal cases, court decisions, and precedents"
    examples: ["Brown v. Board of Education", "Roe v. Wade"]

  - type_name: party
    description: "Parties involved in legal matters (plaintiff, defendant, etc.)"
    examples: ["Plaintiff", "Defendant", "Third-party Intervenor"]

  - type_name: jurisdiction
    description: "Courts, jurisdictions, and legal authorities"
    examples: ["9th Circuit Court of Appeals", "California Supreme Court"]
```

**Medical Domain:**
```yaml
entity_types:
  - type_name: disease
    description: "Diseases, conditions, and medical diagnoses"
    examples: ["Type 2 Diabetes", "Hypertension", "COVID-19"]

  - type_name: medication
    description: "Medications, drugs, and pharmaceutical treatments"
    examples: ["Metformin", "Lisinopril", "Ibuprofen"]

  - type_name: procedure
    description: "Medical procedures, surgeries, and treatments"
    examples: ["MRI Scan", "Appendectomy", "Physical Therapy"]

  - type_name: symptom
    description: "Symptoms, signs, and clinical presentations"
    examples: ["Fever", "Chest Pain", "Fatigue"]
```

**Technical Documentation Domain:**
```yaml
entity_types:
  - type_name: api_endpoint
    description: "API endpoints and routes"
    examples: ["POST /api/v1/documents", "GET /health"]

  - type_name: function
    description: "Functions, methods, and code components"
    examples: ["ingest_document()", "validate_metadata()"]

  - type_name: error_code
    description: "Error codes and status codes"
    examples: ["HTTP 404", "ERR_CONNECTION_TIMEOUT"]

  - type_name: configuration
    description: "Configuration parameters and environment variables"
    examples: ["MAX_FILE_SIZE", "NEO4J_URI"]
```

### Pydantic Model Structure
[Source: architecture/coding-standards.md]

Example Pydantic models:

```python
from __future__ import annotations
from typing import List
from pydantic import BaseModel, Field, field_validator

class EntityTypeDefinition(BaseModel):
    """Definition of a single entity type."""
    type_name: str = Field(..., description="Entity type name (lowercase, no spaces)")
    description: str = Field(..., description="Description of what this entity type represents")
    examples: List[str] = Field(
        default_factory=list,
        description="Example entities of this type"
    )

    @field_validator('type_name')
    @classmethod
    def validate_type_name(cls, v):
        """Ensure type_name is lowercase and contains no spaces."""
        if not v.islower():
            raise ValueError("type_name must be lowercase")
        if ' ' in v:
            raise ValueError("type_name cannot contain spaces")
        return v

class EntityTypesConfig(BaseModel):
    """Complete entity types configuration."""
    entity_types: List[EntityTypeDefinition] = Field(
        ...,
        description="List of entity type definitions"
    )

    def get_type_names(self) -> List[str]:
        """Return list of entity type names."""
        return [et.type_name for et in self.entity_types]

    def add_entity_type(self, entity_type: EntityTypeDefinition):
        """Add new entity type if unique."""
        if entity_type.type_name in self.get_type_names():
            raise ValueError(f"Entity type '{entity_type.type_name}' already exists")
        self.entity_types.append(entity_type)
```

### API Endpoint Specification
[Source: Epic 2 Story 2.5 AC4, AC5]

**Endpoint:** `GET /api/v1/config/entity-types`

**Response Format (200 OK):**
```json
{
  "entity_types": [
    {
      "type_name": "person",
      "description": "Individual people, including names, roles, and titles",
      "examples": ["John Doe", "Dr. Jane Smith", "CEO Bob Johnson"]
    },
    {
      "type_name": "organization",
      "description": "Companies, institutions, agencies, and groups",
      "examples": ["Microsoft Corporation", "Stanford University"]
    }
  ]
}
```

**Endpoint:** `POST /api/v1/config/entity-types`

**Request Format:**
```json
{
  "type_name": "patent",
  "description": "Patents, intellectual property, and inventions",
  "examples": ["US Patent 10,123,456", "European Patent EP1234567"]
}
```

**Response Format (201 Created):**
```json
{
  "message": "Entity type 'patent' added successfully",
  "entity_type": {
    "type_name": "patent",
    "description": "Patents, intellectual property, and inventions",
    "examples": ["US Patent 10,123,456", "European Patent EP1234567"]
  }
}
```

**Error Response (409 Conflict - Duplicate Type):**
```json
{
  "error": {
    "code": "ENTITY_TYPE_EXISTS",
    "message": "Entity type 'patent' already exists"
  }
}
```

### LightRAG Integration Interface
[Source: Epic 2 Story 2.5 AC6, architecture/components.md]

Placeholder for Epic 3 integration:

```python
# shared/models/lightrag_config.py
from typing import List

class LightRAGConfig:
    """Configuration for LightRAG service (Epic 3)."""

    def __init__(self, entity_types: List[str]):
        self.entity_types = entity_types

    def get_entity_extraction_prompt(self) -> str:
        """Generate prompt for entity extraction with configured types."""
        # TODO: Epic 3 - Implement LightRAG entity extraction prompt
        entity_list = ", ".join(self.entity_types)
        return f"Extract entities of these types: {entity_list}"
```

### Configuration Persistence
[Source: Epic 2 Story 2.5 AC5]

```python
# shared/config/entity_loader.py
import yaml
from pathlib import Path
from shared.models.entity_types import EntityTypesConfig, EntityTypeDefinition

def load_entity_types(file_path: str) -> EntityTypesConfig:
    """Load entity types from YAML configuration file."""
    with open(file_path, 'r') as f:
        data = yaml.safe_load(f)
    return EntityTypesConfig(**data)

def save_entity_types(config: EntityTypesConfig, file_path: str):
    """Save entity types configuration to YAML file."""
    data = config.model_dump()
    with open(file_path, 'w') as f:
        yaml.dump(data, f, default_flow_style=False, sort_keys=False)
```

### Coding Standards
[Source: architecture/coding-standards.md]

**Critical Rules:**
- **Type Safety:** Use Pydantic V2 for all models; strict type hints
- **Configuration:** Load entity types at startup; cache configuration
- **Error Handling:** Handle YAML parsing errors gracefully
- **Validation:** Ensure type_name uniqueness before adding
- **File I/O:** Use async file operations where possible; handle permission errors

**Naming Conventions:**
- Modules: `snake_case` (e.g., `entity_loader.py`)
- Classes: `PascalCase` (e.g., `EntityTypeDefinition`)
- Functions: `snake_case` (e.g., `load_entity_types()`)
- Constants: `SCREAMING_SNAKE_CASE` (e.g., `DEFAULT_ENTITY_TYPES`)

### Testing Standards
[Source: architecture/testing-strategy.md]

**Testing Requirements:**
- **Unit Tests (shared/tests/test_entity_types.py):**
  - Test EntityTypeDefinition validation
  - Test type_name lowercase validation
  - Test type_name uniqueness validation
  - Test entity types loading from YAML
  - Test entity types persistence to YAML
  - Use pytest fixtures for sample configurations

**Test File Organization:**
```
shared/tests/
├── conftest.py                  # Pytest fixtures (sample configs)
├── test_entity_types.py         # Entity type model tests
└── fixtures/
    ├── valid-entity-types.yaml
    └── invalid-entity-types.yaml

services/api/tests/
├── integration/
│   └── test_entity_config.py    # API integration tests
└── conftest.py
```

**Test Example:**
```python
import pytest
from shared.models.entity_types import EntityTypeDefinition, EntityTypesConfig
from shared.config.entity_loader import load_entity_types, save_entity_types

def test_entity_type_validation_lowercase():
    """Test type_name must be lowercase."""
    with pytest.raises(ValueError, match="lowercase"):
        EntityTypeDefinition(
            type_name="Person",  # Invalid: uppercase
            description="Test",
            examples=[]
        )

def test_entity_type_validation_no_spaces():
    """Test type_name cannot contain spaces."""
    with pytest.raises(ValueError, match="spaces"):
        EntityTypeDefinition(
            type_name="legal case",  # Invalid: contains space
            description="Test",
            examples=[]
        )

def test_add_entity_type_unique():
    """Test adding unique entity type succeeds."""
    config = EntityTypesConfig(entity_types=[
        EntityTypeDefinition(
            type_name="person",
            description="People",
            examples=[]
        )
    ])

    new_type = EntityTypeDefinition(
        type_name="organization",
        description="Organizations",
        examples=[]
    )

    config.add_entity_type(new_type)
    assert len(config.entity_types) == 2

def test_add_entity_type_duplicate():
    """Test adding duplicate entity type raises error."""
    config = EntityTypesConfig(entity_types=[
        EntityTypeDefinition(
            type_name="person",
            description="People",
            examples=[]
        )
    ])

    duplicate = EntityTypeDefinition(
        type_name="person",  # Duplicate
        description="Different description",
        examples=[]
    )

    with pytest.raises(ValueError, match="already exists"):
        config.add_entity_type(duplicate)

def test_load_entity_types_from_yaml(tmp_path):
    """Test loading entity types from YAML file."""
    yaml_content = """
entity_types:
  - type_name: person
    description: "People"
    examples: ["John Doe"]
  - type_name: organization
    description: "Organizations"
    examples: ["Acme Inc."]
"""
    config_file = tmp_path / "entity-types.yaml"
    config_file.write_text(yaml_content)

    config = load_entity_types(str(config_file))

    assert len(config.entity_types) == 2
    assert config.entity_types[0].type_name == "person"
    assert config.entity_types[1].type_name == "organization"

def test_save_entity_types_to_yaml(tmp_path):
    """Test saving entity types to YAML file."""
    config = EntityTypesConfig(entity_types=[
        EntityTypeDefinition(
            type_name="person",
            description="People",
            examples=["John Doe"]
        )
    ])

    config_file = tmp_path / "entity-types.yaml"
    save_entity_types(config, str(config_file))

    # Verify file was created and is valid
    assert config_file.exists()
    loaded_config = load_entity_types(str(config_file))
    assert len(loaded_config.entity_types) == 1
    assert loaded_config.entity_types[0].type_name == "person"

@pytest.mark.asyncio
async def test_get_entity_types_endpoint(async_client: AsyncClient):
    """Test GET /api/v1/config/entity-types endpoint."""
    response = await async_client.get("/api/v1/config/entity-types")

    assert response.status_code == 200
    result = response.json()
    assert "entity_types" in result
    assert len(result["entity_types"]) >= 8  # Default entity types

@pytest.mark.asyncio
async def test_post_entity_type_endpoint(async_client: AsyncClient):
    """Test POST /api/v1/config/entity-types endpoint."""
    new_entity = {
        "type_name": "patent",
        "description": "Patents and intellectual property",
        "examples": ["US Patent 10,123,456"]
    }

    response = await async_client.post(
        "/api/v1/config/entity-types",
        json=new_entity,
        headers={"X-API-Key": "test-key-123"}
    )

    assert response.status_code == 201
    result = response.json()
    assert result["entity_type"]["type_name"] == "patent"
```

### Previous Story Insights
[Source: docs/stories/2.2.metadata-schema.md]

**Relevant Learnings from Story 2.2:**
- Configuration loading patterns with Pydantic and YAML
- Use @lru_cache() for caching loaded configurations
- FastAPI dependency injection for configuration access
- Validation error handling with user-friendly messages
- Configuration persistence to YAML files

**Technical Patterns to Follow:**
- Use Pydantic V2 for configuration models
- Load configuration at startup and cache
- Provide API endpoints for dynamic configuration updates
- Persist configuration changes to YAML file
- Include comprehensive examples in documentation

---

## Testing

### Test File Locations
[Source: architecture/testing-strategy.md]

**Unit Tests:**
- `shared/tests/test_entity_types.py` - Entity type model and validation tests
- `shared/tests/conftest.py` - Pytest fixtures

**Integration Tests:**
- `services/api/tests/integration/test_entity_config.py` - API endpoint tests

**Test Fixtures:**
- `shared/tests/fixtures/valid-entity-types.yaml` - Valid configuration examples
- `shared/tests/fixtures/invalid-entity-types.yaml` - Invalid configuration for error testing

### Testing Approach
[Source: architecture/testing-strategy.md]

1. **Unit Tests (70%)**: Test Pydantic models and configuration loading
2. **Integration Tests (30%)**: Test API endpoints for entity type management
3. **Coverage Target**: 80%+ for entity_types.py and entity_loader.py

### Required Test Scenarios
- Entity type validation (lowercase, no spaces)
- Uniqueness validation
- Configuration loading from YAML
- Configuration persistence to YAML
- GET endpoint returns default entity types
- POST endpoint adds new entity type
- POST endpoint rejects duplicate entity type
- YAML parsing error handling

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-16 | 1.0 | Story created from Epic 2 | Sarah (PO Agent) |

---

## Dev Agent Record

### Agent Model Used
*[To be populated by Dev Agent during implementation]*

### Debug Log References
*[To be populated by Dev Agent during implementation]*

### Completion Notes
*[To be populated by Dev Agent during implementation]*

### File List
*[To be populated by Dev Agent during implementation]*

---

## QA Results
*[To be populated by QA Agent after implementation]*

# Story 3.11: Implement Entity Type Schema Evolution and Re-Extraction

**Epic:** Epic 3 - Graph-Based Retrieval, Knowledge Graph Construction & Visualization
**Story ID:** 3.11
**Status:** Draft
**Estimated Effort:** 3 story points (1 day)

---

## User Story

**As a** domain specialist,
**I want** to add new entity types without losing existing graph data,
**so that** I can refine entity extraction as my understanding of the domain improves.

---

## Acceptance Criteria

1. API endpoint `POST /api/v1/config/entity-types` adds new entity types to `entity-types.yaml`:
   - Accepts: type_name, description, examples
   - Validates type_name uniqueness
   - Persists immediately (no service restart required)
2. New entity types immediately available for future document ingestion
3. Existing documents not automatically re-extracted (opt-in re-extraction):
   - Avoids unexpected LLM costs
   - User explicitly triggers re-extraction when ready
4. API endpoint `POST /api/v1/graph/re-extract` triggers entity re-extraction:
   - Accepts: entity_types (list of new types to extract), document_filters (optional)
   - Returns re_extraction_job_id for progress tracking
   - Re-extraction uses LLM to identify entities of new types in existing document content
5. Re-extraction adds new entities without removing existing ones:
   - Preserves existing entity nodes and relationships
   - Adds new entity nodes of new types
   - Creates new relationships between new and existing entities
6. API endpoint `GET /api/v1/graph/re-extract/{job_id}/status` returns:
   - total_documents, processed_count, entities_added_count, status
7. Entity type changes logged with timestamp, user, and rationale to audit log
8. Documentation in `docs/entity-evolution.md` explains:
   - When to add new entity types
   - Re-extraction cost considerations (LLM API usage)
   - Examples: adding "API Endpoint" type to technical docs, adding "Regulation" type to legal docs
9. Graph statistics endpoint `GET /api/v1/graph/stats` updated to show entity distribution by type (including new types post-re-extraction)

---

## Tasks / Subtasks

- [ ] **Task 1: Implement entity type creation endpoint** (AC: 1, 2)
  - [ ] Create `POST /api/v1/config/entity-types` endpoint
  - [ ] Validate uniqueness, persist to entity-types.yaml
  - [ ] Hot-reload entity types without service restart

- [ ] **Task 2: Implement re-extraction endpoint** (AC: 4, 5)
  - [ ] Create `POST /api/v1/graph/re-extract` endpoint
  - [ ] Create background job to re-extract entities
  - [ ] Add new entities without removing existing ones

- [ ] **Task 3: Implement re-extraction status endpoint** (AC: 6)
  - [ ] Create `GET /api/v1/graph/re-extract/{job_id}/status`
  - [ ] Track progress: total, processed, entities_added

- [ ] **Task 4: Add audit logging** (AC: 7)
  - [ ] Log entity type additions with timestamp, user, rationale

- [ ] **Task 5: Create documentation** (AC: 8)
  - [ ] Create `docs/entity-evolution.md`
  - [ ] Explain when to add entity types
  - [ ] Warn about LLM costs for re-extraction

- [ ] **Task 6: Update graph stats endpoint** (AC: 9)
  - [ ] Include new entity types in distribution stats

---

## Dev Notes

### Entity Type Addition Flow
```
User adds new entity type → Persists to YAML → Reloads in memory
  → Future documents use new types
  → Existing documents unchanged (opt-in re-extraction)
```

### Re-Extraction Flow
```
User triggers re-extraction
  → Background job created
  → For each filtered document:
      → Fetch parsed content
      → Extract entities of new types only
      → Add new Entity nodes
      → Create relationships
  → Track progress
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-17 | 1.0 | Story created from Epic 3 | Sarah (PO Agent) |

---

## Dev Agent Record
<!-- Populated during implementation -->

## QA Results
<!-- Results from QA Agent review -->
